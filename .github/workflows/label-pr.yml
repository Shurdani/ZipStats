name: ðŸ·ï¸ Auto-label PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  label:
    name: Add Labels
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Label PR based on files changed
      uses: actions/labeler@v5
      with:
        repo-token: "${{ secrets.GITHUB_TOKEN }}"
        sync-labels: false
        configuration-path: .github/labeler.yml

    - name: Label by title/description keywords
      uses: actions/github-script@v7
      with:
        script: |
          const title = context.payload.pull_request.title.toLowerCase();
          const body = (context.payload.pull_request.body || '').toLowerCase();
          const text = title + ' ' + body;
          
          // Mapeo de keywords a labels (sin emojis porque labeler usa nombres simples)
          const labelMap = {
            'bug': ['ðŸ› bug', 'bug'],
            'feature': ['âœ¨ feature', 'feature'],
            'ui': ['ðŸŽ¨ ui', 'ui'],
            'refactor': ['ðŸ”§ refactor', 'refactor'],
            'documentation': ['ðŸ“ documentation', 'documentation'],
            'tests': ['ðŸ§ª tests', 'tests']
          };
          
          const labels = [];
          
          if (text.match(/\b(bug|fix|error|issue|problem|corregir|solucionar)\b/)) {
            labels.push(...labelMap.bug);
          } else if (text.match(/\b(feat|feature|new|add|nuev|aÃ±adir)\b/)) {
            labels.push(...labelMap.feature);
          } else if (text.match(/\b(ui|ux|design|visual|theme|interfaz|pantalla)\b/)) {
            labels.push(...labelMap.ui);
          } else if (text.match(/\b(refactor|clean|restructure|refactorizar)\b/)) {
            labels.push(...labelMap.refactor);
          } else if (text.match(/\b(doc|readme|guide|documentation|documentaciÃ³n)\b/)) {
            labels.push(...labelMap.documentation);
          } else if (text.match(/\b(test|spec|testing|prueba)\b/)) {
            labels.push(...labelMap.tests);
          }
          
          // Intentar aÃ±adir labels, ignorar errores si no existen
          if (labels.length > 0) {
            for (const label of labels) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  labels: [label]
                });
              } catch (error) {
                // Ignorar si la label no existe
                console.log(`Label ${label} no encontrada, saltando...`);
              }
            }
          }

