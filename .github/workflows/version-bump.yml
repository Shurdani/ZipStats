name: ü§ñ Auto Version Bump Helper

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Tipo de versi√≥n'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'
      create_release:
        description: 'Crear release autom√°ticamente'
        required: false
        type: boolean
        default: true

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Read current version
      id: current_version
      run: |
        VERSION_NAME=$(grep "versionName" app/build.gradle | sed -n "s/.*versionName \"\(.*\)\".*/\1/p")
        VERSION_CODE=$(grep "versionCode" app/build.gradle | sed -n "s/.*versionCode \(.*\).*/\1/p")
        echo "current_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "current_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "Current version: $VERSION_NAME (code: $VERSION_CODE)"

    - name: Calculate new version
      id: new_version
      run: |
        CURRENT="${{ steps.current_version.outputs.current_name }}"
        IFS='.' read -ra ADDR <<< "$CURRENT"
        MAJOR=${ADDR[0]}
        MINOR=${ADDR[1]}
        PATCH=${ADDR[2]}
        
        TYPE="${{ github.event.inputs.version_type }}"
        case $TYPE in
          major)
            NEW_MAJOR=$((MAJOR + 1))
            NEW_MINOR=0
            NEW_PATCH=0
            ;;
          minor)
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
            ;;
          patch)
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))
            ;;
        esac
        
        NEW_VERSION="$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH"
        NEW_CODE=$(({{ steps.current_version.outputs.current_code }} + 1))
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "new_code=$NEW_CODE" >> $GITHUB_OUTPUT
        echo "‚ú® Nueva versi√≥n: $NEW_VERSION (code: $NEW_CODE)"

    - name: Create version bump PR
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: version-bump-${{ steps.new_version.outputs.new_version }}
        title: "ü§ñ Bump version to ${{ steps.new_version.outputs.new_version }}"
        body: |
          ## ü§ñ Actualizaci√≥n Autom√°tica de Versi√≥n
          
          Este PR actualiza la versi√≥n de la aplicaci√≥n:
          
          - **Versi√≥n anterior**: ${{ steps.current_version.outputs.current_name }} (${{ steps.current_version.outputs.current_code }})
          - **Nueva versi√≥n**: ${{ steps.new_version.outputs.new_version }} (${{ steps.new_version.outputs.new_code }})
          - **Tipo**: ${{ github.event.inputs.version_type }}
          
          ### Cambios realizados
          
          - ‚úÖ Actualizado `versionName` en `app/build.gradle`
          - ‚úÖ Actualizado `versionCode` en `app/build.gradle`
          - ‚úÖ Actualizado badge en `README.md`
          
          ### Siguiente paso
          
          Despu√©s de mergear este PR, crea un tag con:
          ```bash
          git tag -a v${{ steps.new_version.outputs.new_version }} -m "Release ${{ steps.new_version.outputs.new_version }}"
          git push origin v${{ steps.new_version.outputs.new_version }}
          ```
          
          El workflow de release se activar√° autom√°ticamente al hacer push del tag.
        commit-message: "ü§ñ Bump version to ${{ steps.new_version.outputs.new_version }}"
        file: |
          app/build.gradle
          README.md
        replace: |
          ${{ steps.current_version.outputs.current_name }}|${{ steps.new_version.outputs.new_version }}
          versionCode ${{ steps.current_version.outputs.current_code }}|versionCode ${{ steps.new_version.outputs.new_code }}

